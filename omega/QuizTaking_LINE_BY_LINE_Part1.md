# QuizTaking.jsx - Complete Line-by-Line Documentation (Part 1 of 2)

## File Path
`frontend/src/pages/QuizTaking.jsx`

## Purpose
This is the most complex component in the application. It provides the complete quiz-taking experience for candidates, including:
- Real-time countdown timer
- Question navigation
- Answer tracking
- Progress monitoring
- Auto-submission when time expires
- Manual submission

---

## Complete Code Analysis

### Import Statements (Lines 1-3)

```jsx
import { useState, useEffect, useCallback, useRef } from 'react';
import { useNavigate, useParams } from 'react-router-dom';
import { candidateAPI } from '../utils/api';
```

**Line 1: React imports**
- `useState`: Manages multiple state variables (user, quiz, answers, time, etc.)
- `useEffect`: Handles side effects (auth check, timer, quiz start)
- `useCallback`: Memoizes functions to prevent unnecessary re-renders
- `useRef`: Creates persistent references (quizStartedRef, timerRef)

**Line 2: Router imports**
- `useNavigate`: Navigation to results page after submission
- `useParams`: Extracts quizId from URL

**Line 3: API import**
- `candidateAPI`: Methods for getting quiz, starting attempt, submitting answers

---

### Function Component Declaration (Line 5)

```jsx
const QuizTaking = () => {
```

**Line 5: Arrow function component**
- Most complex component in the app
- Manages real-time quiz-taking flow

---

### Hook Initialization (Lines 6-18)

```jsx
const navigate = useNavigate();
const { quizId } = useParams();

// State management
const [user, setUser] = useState(null);
const [quiz, setQuiz] = useState(null);
const [attemptId, setAttemptId] = useState(null);
const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
const [answers, setAnswers] = useState({});
const [timeLeft, setTimeLeft] = useState(0);
const [loading, setLoading] = useState(true);
const [submitting, setSubmitting] = useState(false);

// Use ref to track if quiz has been started
const quizStartedRef = useRef(false);
const timerRef = useRef(null);
```

**Line 6: `const navigate = useNavigate();`**
- Navigation function for redirecting after submission

**Line 7: `const { quizId } = useParams();`**
- Extracts quizId from URL
- Route: `/candidate/quiz/:quizId/take`

**Line 10: `const [user, setUser] = useState(null);`**
- Stores authenticated candidate information
- Used for display and validation

**Line 11: `const [quiz, setQuiz] = useState(null);`**
- Complete quiz object with all questions and options
- Initially null until fetched

**Line 12: `const [attemptId, setAttemptId] = useState(null);`**
- Unique ID for this specific quiz attempt
- Generated by backend when quiz starts
- Used for final submission

**Line 13: `const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);`**
- Index of currently displayed question (0-based)
- Starts at first question
- Used for navigation between questions

**Line 14: `const [answers, setAnswers] = useState({});`**
- Object storing all answers
- Key: questionId, Value: answer object
- Structure: `{ [questionId]: { questionId, selectedOptionId, textAnswer, visited } }`

**Line 15: `const [timeLeft, setTimeLeft] = useState(0);`**
- Remaining time in seconds
- Counts down from quiz duration
- When reaches 0, auto-submits

**Line 16: `const [loading, setLoading] = useState(true);`**
- Shows loading spinner during initial setup
- Set to false after quiz data loaded

**Line 17: `const [submitting, setSubmitting] = useState(false);`**
- Prevents double submission
- Disables UI during submission process

**Line 20: `const quizStartedRef = useRef(false);`**
- **Critical ref to prevent duplicate quiz starts**
- React 18 StrictMode calls effects twice in development
- Ref persists across re-renders, unlike state
- Ensures quiz only starts once

**Line 21: `const timerRef = useRef(null);`**
- Stores reference to timer interval
- Allows clearing interval when needed
- Prevents memory leaks

---

### Authentication Effect (Lines 24-40)

```jsx
useEffect(() => {
  const userData = localStorage.getItem('user');
  if (!userData) {
    navigate('/');
    return;
  }
  const parsedUser = JSON.parse(userData);
  if (parsedUser.role !== 'CANDIDATE') {
    navigate('/');
    return;
  }
  setUser(parsedUser);
  
  // Start quiz only once
  if (!quizStartedRef.current) {
    quizStartedRef.current = true;
    startQuizAttempt();
  }
}, []);
```

**Line 24: `useEffect(() => {`**
- Runs once on component mount
- Empty dependency array `[]`

**Lines 25-30: Authentication checks**
- Retrieves user from localStorage
- If no user data: redirect to home (login)
- Parses JSON string to object
- If not a CANDIDATE: redirect (admins can't take quizzes)

**Line 35: `setUser(parsedUser);`**
- Stores validated user in state
- Used for display in header

**Lines 38-41: Quiz start logic**
- **Line 38**: Checks if quiz already started
- **Line 39**: Sets ref to true (permanently)
- **Line 40**: Calls startQuizAttempt()
- This pattern prevents duplicate API calls in React 18

**Line 42: `}, []);`**
- Empty dependencies: run once
- `navigate` could be added but never changes

---

### Timer Effect (Lines 43-70)

```jsx
useEffect(() => {
  // Only start timer if quiz is loaded and not submitting
  if (!quiz || submitting) {
    return;
  }

  // Start the countdown timer
  const timer = setInterval(() => {
    setTimeLeft((prev) => {
      if (prev <= 1) {
        // Time's up - auto submit
        clearInterval(timer);
        if (!submitting) {
          setSubmitting(true);
          submitQuizToBackend(false);
        }
        return 0;
      }
      return prev - 1;
    });
  }, 1000);

  // Store timer reference
  timerRef.current = timer;

  // Cleanup function
  return () => {
    if (timer) {
      clearInterval(timer);
    }
  };
}, [quiz, submitting]);
```

**Lines 44-47: Guard conditions**
- Don't start timer if quiz not loaded yet
- Don't start timer if already submitting
- Early return prevents timer creation

**Line 50: `const timer = setInterval(() => {`**
- Creates interval that runs every 1000ms (1 second)
- Returns timer ID for later clearing

**Line 51: `setTimeLeft((prev) => {`**
- Functional update pattern
- Uses previous value to calculate next
- Ensures accurate countdown even with re-renders

**Lines 52-59: Time expiration logic**
- **Line 52**: If 1 second or less remaining
- **Line 54**: Clear the interval immediately
- **Lines 55-57**: If not already submitting, start submission
  - Set submitting to true
  - Call submitQuizToBackend with false (no alerts)
- **Line 58**: Return 0 for time
- This auto-submits the quiz when time runs out

**Line 60: `return prev - 1;`**
- Normal countdown: decrement by 1 second

**Line 64: `timerRef.current = timer;`**
- Store timer ID in ref
- Allows access from other parts of component

**Lines 67-71: Cleanup function**
- Runs when component unmounts or dependencies change
- Clears interval to prevent memory leaks
- Critical for proper resource management

**Line 72: `}, [quiz, submitting]);`**
- Re-runs if quiz or submitting changes
- Quiz: Start timer once quiz loads
- Submitting: Stop timer when submission starts

---

### Start Quiz Attempt Function (Lines 74-102)

```jsx
const startQuizAttempt = async () => {
  try {
    // Fetch quiz details first
    const quizData = await candidateAPI.getQuiz(quizId);
    
    // Initialize answers object BEFORE starting attempt
    const initialAnswers = {};
    quizData.questions.forEach(q => {
      initialAnswers[q.id] = {
        questionId: q.id,
        selectedOptionId: null,
        textAnswer: '',
        visited: false
      };
    });
    setAnswers(initialAnswers);
    setQuiz(quizData);
    
    // Now start the attempt
    const attemptData = await candidateAPI.startQuiz(quizId);
    setAttemptId(attemptData.id);
    setTimeLeft(quizData.duration * 60); // Convert minutes to seconds
    setLoading(false);
    
  } catch (error) {
    console.error('Error starting quiz:', error);
    alert('Failed to start quiz: ' + error.message);
    navigate('/candidate');
  }
};
```

**Line 74: `const startQuizAttempt = async () => {`**
- Async function for quiz initialization
- Called once by useEffect

**Line 75: `try {`**
- Error handling block

**Line 77: `const quizData = await candidateAPI.getQuiz(quizId);`**
- Fetches quiz details from backend
- Includes title, description, duration, questions, options
- Must complete before starting attempt

**Lines 80-90: Initialize answers object**
- **Line 80**: Empty object to populate
- **Line 81**: Loop through all questions
- **Lines 82-87**: Create answer structure for each question:
  - `questionId`: Links answer to question
  - `selectedOptionId`: null (not answered yet)
  - `textAnswer`: Empty string (for SHORT_ANSWER)
  - `visited`: false (question not viewed yet)

**Line 89: `setAnswers(initialAnswers);`**
- Sets initial answer state
- Done BEFORE starting attempt
- Ensures UI is ready when quiz starts

**Line 90: `setQuiz(quizData);`**
- Stores quiz data in state
- Triggers timer effect to start

**Line 93: `const attemptData = await candidateAPI.startQuiz(quizId);`**
- Registers attempt with backend
- Backend records start time
- Returns attempt object with ID

**Line 94: `setAttemptId(attemptData.id);`**
- Stores attempt ID for later submission

**Line 95: `setTimeLeft(quizData.duration * 60);`**
- Sets timer to quiz duration
- Duration is in minutes, converted to seconds
- Example: 30 minutes = 1800 seconds

**Line 96: `setLoading(false);`**
- Ends loading state
- UI renders and timer starts

**Lines 98-102: Error handling**
- Logs error to console
- Shows alert to user
- Navigates back to dashboard
- User can't proceed if quiz fails to load

---

### Answer Selection Handler (Lines 105-113)

```jsx
const handleAnswerSelect = (questionId, optionId) => {
  setAnswers(prev => ({
    ...prev,
    [questionId]: {
      ...prev[questionId],
      selectedOptionId: optionId,
      visited: true
    }
  }));
};
```

**Line 105: Function declaration**
- Called when user clicks an option
- Receives questionId and optionId

**Line 106: `setAnswers(prev => ({`**
- Functional update with previous state
- Preserves other questions' answers

**Line 107: `...prev,`**
- Spread operator copies all existing answers
- Only updates the specific question

**Lines 108-112: Update specific question**
- `[questionId]`: Dynamic key (computed property)
- `...prev[questionId]`: Spread existing answer properties
- `selectedOptionId: optionId`: Records selected option
- `visited: true`: Marks question as visited

---

### Text Answer Handler (Lines 116-124)

```jsx
const handleTextAnswer = (questionId, text) => {
  setAnswers(prev => ({
    ...prev,
    [questionId]: {
      ...prev[questionId],
      textAnswer: text,
      visited: true
    }
  }));
};
```

**Line 116: Function for SHORT_ANSWER questions**
- Similar to handleAnswerSelect but for text

**Lines 117-123: Update text answer**
- Same pattern as handleAnswerSelect
- Updates `textAnswer` instead of `selectedOptionId`
- Also marks as visited

---

### Clear Response Handler (Lines 127-137)

```jsx
const handleClearResponse = () => {
  if (!quiz) return;
  const currentQuestion = quiz.questions[currentQuestionIndex];
  setAnswers(prev => ({
    ...prev,
    [currentQuestion.id]: {
      ...prev[currentQuestion.id],
      selectedOptionId: null,
      textAnswer: ''
    }
  }));
};
```

**Line 127: Clear current answer**

**Line 128: Guard: quiz must exist**

**Line 129: Get current question object**
- Uses currentQuestionIndex to find question

**Lines 130-136: Reset answer**
- Clears both selectedOptionId and textAnswer
- Doesn't change visited status
- User can clear and re-answer

---

### Save and Next Handler (Lines 140-161)

```jsx
const handleSaveAndNext = () => {
  if (!quiz) return;
  
  const currentQuestion = quiz.questions[currentQuestionIndex];
  const currentAnswer = answers[currentQuestion.id];
  
  // Check if answer is provided
  if (!currentAnswer?.selectedOptionId && !currentAnswer?.textAnswer?.trim()) {
    alert('Please provide an answer before saving.');
    return;
  }
  
  // Mark as visited (answer is already saved in state from handleAnswerSelect/handleTextAnswer)
  setAnswers(prev => ({
    ...prev,
    [currentQuestion.id]: {
      ...prev[currentQuestion.id],
      visited: true
    }
  }));

  // Move to next question if available
  if (currentQuestionIndex < quiz.questions.length - 1) {
    setCurrentQuestionIndex(currentQuestionIndex + 1);
  } else {
    alert('This is the last question. You can now submit the quiz.');
  }
};
```

**Line 140: Save current answer and navigate**

**Line 141: Guard: quiz must exist**

**Line 143: Get current question**

**Line 144: Get current answer from state**

**Lines 147-150: Validation**
- Checks if MCQ option selected OR text answer provided
- `.trim()` removes whitespace (empty text not valid)
- Alerts user if no answer
- Returns early, doesn't navigate

**Lines 153-159: Mark as visited**
- Answer already saved by handleAnswerSelect/handleTextAnswer
- This just ensures visited flag is set
- Confirmation that user explicitly saved

**Lines 162-166: Navigation logic**
- **Line 162**: If not last question
- **Line 163**: Move to next question (increment index)
- **Lines 164-165**: If last question
  - Alert user they're done
  - Suggest submitting
  - Don't navigate (no next question)

---

### Question Navigation Handler (Lines 169-171)

```jsx
const handleQuestionNavigation = (index) => {
  setCurrentQuestionIndex(index);
};
```

**Line 169: Jump to specific question**
- Called from sidebar question grid
- `index`: 0-based question index
- Allows non-linear navigation

---

### Submit Quiz Handler (Lines 174-189)

```jsx
const handleSubmitQuiz = () => {
  if (submitting) return;

  const confirmSubmit = window.confirm(
    'Are you sure you want to submit the quiz? You cannot change your answers after submission.'
  );
  
  if (!confirmSubmit) return;

  setSubmitting(true);
  
  // Clear timer
  if (timerRef.current) {
    clearInterval(timerRef.current);
  }
  
  submitQuizToBackend(true);
};
```

**Line 174: User-initiated submission**

**Line 175: Prevent double submission**
- If already submitting, do nothing

**Lines 177-179: Confirmation dialog**
- Native browser confirm dialog
- Warns user submission is final
- Returns true if OK, false if Cancel

**Line 181: User cancelled**
- Return early, don't submit

**Line 183: Set submitting flag**
- Prevents further submissions
- Disables UI interactions

**Lines 186-188: Stop timer**
- Clear the interval immediately
- Prevents timer from reaching 0 during submission
- Uses ref to access timer ID

**Line 190: Call actual submission**
- `true`: Show alerts (user-initiated)

---

## Continued in Part 2...

The quiz taking component has many more critical sections including:
- submitQuizToBackend function (actual API submission)
- formatTime function (time display)
- getQuestionStatus function (answered/unanswered/not-visited)
- Complex JSX rendering (header, question display, sidebar)
- Question grid navigation
- Progress tracking

Let me continue with Part 2 of the documentation.
